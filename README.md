# refractr [![Build Status](https://travis-ci.com/mozilla-it/refractr.svg?branch=master)](https://travis-ci.com/mozilla-it/refractr)
Containerized HTTP redirect and rewrite service with automatic Let's Encrypt SSL certs

[![Build Status](https://travis-ci.com/mozilla-it/refractr.svg?branch=master)](https://travis-ci.com/mozilla-it/refractr)

# Refractr at Mozilla
Refractr at Mozilla runs in our itse-apps cluster and is installed via a HelmRelease in the it-sre-apps github repo.

# Installing refractr in Kubernetes outside Mozilla
See the [helm chart](https://github.com/mozilla-it/helm-charts/tree/master/charts/refractr/README.md)

# Refractr.yml Spec
This is the refractr (redirects|rewrites) spec file. First let's talk about
the values that do not have to be specified and have sane defaults.

### `srcs` key:
This is the list of domains that requests will be redirected or rewritten
from. By default these never have the `http(s)://` schemes. In the simple
case (Ex1) they can be single scalar string value. But they can also be
an array of strings as well (Ex2).

### `dst` key:
This is the destination that the redirect or rewrite will send the request.
In most cases this is a single `https://` prefixed url.  But in the
more complicated redirects (Ex3) and rewrites (Ex4) it can have path
logic or rewrite condtinals, respectively.

### `status` key:
One thing to remember all refractr entires is that they default to:
`status: 301` for doing redirects. Therefore, if not specified with
`status` key, it will be 301.

### `tests` key:
These are the `key: value` pairs that will be used during testing prior
to deploy.  They are written `src: dst`.  The tests will be generated by
default via product of dst * srcs. If the `tests` key is specified, the
autogenerate feature will be disabled in favor of the user-specified
tests.

## Entries(Refract)
There are several ways to input a refractr. All entries will be preceeded
with `-` because they are items in the `refractr` list (top level key).

### Simple:
Often the need is a simple redirect from one domain to another.
A simple refract can be specified as single `key: value` pair item
in the refracts list of items. The `key: value` pair in this case is:
`destination: source(s)`. The destination is a single web url complete
with the https:// scheme. Whereas the source(s) can be a single source
domain or list of multiples.

- Ex1 One Source
```
- destination(dst): source(srcs)
```
```
- https://wiki.mozilla.org: wiki.mozilla.com
```

Here any requests that go to wiki.mozilla.com will be redirected to
https://wiki.mozilla.org.

The loaded data structure will be this:
```
- srcs:
  - wiki.mozilla.com
  dst: https://wiki.mozilla.org/
  status: 301
  tests:
  - http://wiki.mozilla.com: https://wiki.mozilla.org/
```
Note: remember the status and tests are defaults if unspecified.

- Ex2 Multiple Sources
```
- destination(dst):
  - source1
  - source2
```
```
- https://www.mozillalabs.com/:
  - labs.mozilla.org
  - labs.mozilla.com
```
Here is the use case when you need to supply more than one source domain.

The loaded data structure will be this:
```
- srcs:
  - labs.mozilla.org
  - labs.mozilla.com
  dst: https://www.mozillalabs.com/
  status: 301
  tests:
  - http://labs.mozilla.com: https://www.mozillalabs.com/
```
Note: remember the status and tests are defaults if unspecified.

### Complex(Native):

Sometimes the refract requires more control and input, especially
when specifying a rewrite which requires this format. The handling
of 'status' and 'tests' is exactly as above, but often you will want
to specify the tests key: value `src: dst` pairs because rewrites can't
deduce what would be good tests.

Sometimes for a redirect, you want to redirect paths on the domain to different
destinations.  This is done via key: value (path: dst) under the 'dst' key. The
sources will be the product of paths * srcs

- Ex3 Redirect, Paths -> Destinations
```
- srcs: src(s)
  dst:
    path1: dst1
    path2: dst2
```
```
- srcs: lockwise.firefox.com
  dst:
  - /faq.html: https://support.mozilla.org/products/firefox-lockwise/
  - /addon/updates.json: https://mozilla-lockwise.github.io/addon/updates.json
  - /: https://www.mozilla.org/firefox/lockwise/
```
The loaded data structure will be this:
```
- srcs:
  - lockwise.firefox.com
  dst:
  - /faq.html: https://support.mozilla.org/products/firefox-lockwise/
  - /addon/updates.json: https://mozilla-lockwise.github.io/addon/updates.json
  - /: https://www.mozilla.org/firefox/lockwise/
  status: 301
  tests:
  - http://lockwise.firefox.com/faq.html: https://support.mozilla.org/products/firefox-lockwise/
  - http://lockwise.firefox.com/addon/updates.json: https://mozilla-lockwise.github.io/addon/updates.json
  - http://lockwise.firefox.com/: https://www.mozilla.org/firefox/lockwise/
```
Note: remember the status and tests are defaults if unspecified. Here you
can see how the tests specify `src: dst` incorporating the path fragments.

- Ex4 Rewrite with If and Redirect Directives
```
- srcs: src(s)
  dst:
  - if <some-valid-nginx-predicate>
    ^: <rewrite>
  - redirect: (optional) <catchall-redirect> (used when the 'if' condtional fails)
```
```
- srcs:
  - '*.start.mozilla.com'
  - '*.start2.mozilla.com'
  - '*.start3.mozilla.com'
  - '*.start-prod.mozilla.com'
  dst:
  - if: '$http_host ~ "^(?<lang>[a-z]{2,3}(-[a-z]{2})?)?\.(start.*)$"'
    ^: https://start.mozilla.org/$lang$request_uri
  - redirect: https://start.mozilla.org/
  tests:
  - http://ca.start.mozilla.com: https://start.mozilla.org/ca/
  - http://en-us.start.mozilla.com: https://start.mozilla.org/en-us/
  - http://en-uk.start.mozilla.com: https://start.mozilla.org/en-uk/
```
The loaded data structure will be this:
```
- srcs:
  - '*.start.mozilla.com'
  - '*.start2.mozilla.com'
  - '*.start3.mozilla.com'
  - '*.start-prod.mozilla.com'
  dst:
  - ^: https://start.mozilla.org/$lang$request_uri
    if: $http_host ~ "^(?<lang>[a-z]{2,3}(-[a-z]{2})?)?\.(start.*)$"
  - redirect: https://start.mozilla.org/
  status: 301
  tests:
  - http://ca.start.mozilla.com: https://start.mozilla.org/ca/
  - http://en-us.start.mozilla.com: https://start.mozilla.org/en-us/
  - http://en-uk.start.mozilla.com: https://start.mozilla.org/en-uk/
```
Note: In the complex(native) case the 'src' and 'dst' keys match
exactly. As before, 'status' will default to 301 if not specified.
However, the 'tests' must be specified for rewrites such as this.
