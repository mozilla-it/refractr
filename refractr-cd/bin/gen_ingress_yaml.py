#!/usr/bin/env python3
""" Generate stage and prod ingress.yaml from a template file and the list of source domain names as generated by refractr """

from jinja2 import Environment, FileSystemLoader
import yaml
import subprocess
import os
import sys

# Get the list of domains from refractr
refractr = os.path.dirname(sys.argv[0]) + '/../../bin/refractr'
if not os.path.isfile(refractr):
    print('Unable to find refractr executable')
    sys.exit(1)
sp = subprocess.Popen([refractr, '--domains-only'], stderr=subprocess.PIPE, stdout=subprocess.PIPE)
out, err = sp.communicate()
domains = yaml.safe_load(out)
if not domains:
    print(f'Unable to load list of domains from refractr, did you activate the virtualenv?')
    sys.exit(2)

# Find ingress template file
templatefile = os.path.realpath(os.path.dirname(sys.argv[0]) + '/../ingress.yaml.template')
if not os.path.isfile(templatefile):
    print(f'Unable to find {dir} ingress.yaml.template {templatefile}')
    sys.exit(3)

# Load Jinja2 templates
env = Environment(loader=FileSystemLoader(os.path.dirname(templatefile)), trim_blocks=True, lstrip_blocks=True)
template = env.get_template(os.path.basename(templatefile))

# Render template using data and print the output
output = template.render(domains)
ingress = os.path.dirname(templatefile) + '/ingress.yaml'
with open(ingress, 'w') as f:
    f.write(output)
print(f'Wrote {ingress} output file')
