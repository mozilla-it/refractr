# SRE Info
This is the SRE_INFO.md file which should be found in the root of any source code that is administered by the Mozilla SRE Green team. We are available on #sre on slack.

## Overview
Refractr, the application, involves the following parts:

- refractr DSL, schema & python code to validate, translate YAML to Nginx configurations and a Kubernetes Ingress manifest;
- doit DSL (dodo.py) to run meta-tasks for this pipeline as part of CD & the entrypoint of the generated Docker Image (used to either run Nginx or, for the job, run kubectl apply -f new-ingress.yaml);
- docker & docker compose files for creating refractr entrypoint-modified nginx image as well as running the testing suite (only run in local or throwaway environments);
- generated nginx configurations & kubernetes yaml (shipped via being copied into the Docker image, generated by doit commands);

## Doit (dodo.py)

Doit is a Python framework meant to replace Makefiles and similar tools. The following are the Doit tasks we have defined and run as part of CI for Refractr:

1. doit schema (validate dev-refractr.yaml or prod-refractr.yaml - depending on branch - against refractr/schema.yml
1. doit nginx (generate nginx configurations from dev|prod-refractr.yaml)
1. doit ingress (generate ingress manifest from dev|prod-refractr.yaml)
1. doit refracts (generate refracts.json from dev|prod-refractr.yaml - uncertain what these are used for ever)
1. doit deployed (generate deployed file from environment)
1. doit version (generate version file from environment)
1. doit drun (run everything below for docker compose build, run, checks & tests)
1. doit build (builds refractr/Dockerfile Image via docker compose commands)
1. doit check (runs nginx -t against nginx configurations served via docker compose & generated from dev|prod-refractr.yaml above)
1. doit test (run pytest tests against docker image running via docker compose)
1. doit publish (pushes image generated above to ECR)

## Infra Access
Currently this is a EKS cluster and requires the ~/.kube/config file to be present
so that k8s commands will work.  This is usually acquired via [MAWS](https://mana.mozilla.org/wiki/display/SECURITY/How+to+login+to+AWS+with+Single+Sign+On)

[SRE aws-vault setup](https://mana.mozilla.org/wiki/display/SRE/aws-vault)

[SRE account guide](https://mana.mozilla.org/wiki/display/SRE/AWS+Account+access+guide)

[SRE AWS accounts](https://github.com/mozilla-it/itsre-accounts/blob/master/accounts/mozilla-itsre/terraform.tfvars#L5)

## Secrets
Secrets are handled via [AWS Secrets Manager](https://aws.amazon.com/secrets-manager/)

## Source Repos
[refractr](https://github.com/mozilla-it/refractr)

## Infra Repos
[helm-charts](https://github.com/mozilla-it/helm-charts/)
[itse-apps-stage-1-infra](https://github.com/mozilla-it/itse-apps-stage-1-infra)
[itse-apps-prod-1-infra](https://github.com/mozilla-it/itse-apps-prod-1-infra)

## Monitoring
Monitoring is done by the [Mozlenium](https://github.com/mozilla-it/mozlenium)

### Determining app health
* stage
    * `curl -k https://refractr.allizom.org/version`
    * `curl -k https://refractr.allizom.org/deployed`
* prod
    * `curl https://refractr.mozilla.org/version`
    * `curl https://refractr.mozilla.org/deployed`

### SSL Expiry checks in New Relic
[newbie.mozilla-slack.app](https://synthetics.newrelic.com/accounts/2239138/monitors/554cb212-7ab3-494d-af42-73495bf01ac7)

## SSL Certificates
Refractr uses LE certificates via the [cert-manager](https://cert-manager.io/)

## Cloud Account
AWS account itsre-apps 783633885093
